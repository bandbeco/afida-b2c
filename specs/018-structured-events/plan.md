# Implementation Plan: Structured Events Infrastructure

**Branch**: `018-structured-events` | **Date**: 2026-01-16 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/018-structured-events/spec.md`

## Summary

Implement application-wide structured event reporting using Rails 8.1's `Rails.event` API to track customer journey events (email signup, cart, checkout, orders) and operational events (webhooks, payments, order lifecycle). Events are formatted as JSON and flow to Logtail for querying and debugging. The subscriber pattern enables future destinations (PostHog) without code changes.

## Technical Context

**Language/Version**: Ruby 3.4.7 / Rails 8.1.1
**Primary Dependencies**: Rails 8.1 (provides `Rails.event` API), logtail-rails gem (structured log transport)
**Storage**: N/A (events are logged, not persisted to database)
**Testing**: Minitest with `assert_event_reported` / `assert_no_event_reported` helpers from Rails 8.1
**Target Platform**: Linux server (production), macOS (development)
**Project Type**: Web application (Rails monolith)
**Performance Goals**: Event emission adds <1ms per request; no blocking I/O in hot path
**Constraints**: Events logged synchronously via Rails logger; no queuing infrastructure needed
**Scale/Scope**: ~20 event types across 10+ controllers/services

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Test-First Development | ✅ PASS | Tests will use `assert_event_reported` helpers; fixtures already exist for models being instrumented |
| II. SEO & Structured Data | ✅ N/A | No public-facing pages added |
| III. Performance & Scalability | ✅ PASS | Synchronous logging via Rails logger; no N+1 risk; <1ms overhead per event |
| IV. Security & Payment Integrity | ✅ PASS | No new credentials exposed; event payloads use existing logged data; Logtail token in credentials |
| V. Code Quality & Maintainability | ✅ PASS | Single responsibility (subscriber pattern); RuboCop compliance; clear naming conventions |

**Technology Standards Check**:
- ✅ Backend: Rails 8.1.1 (matches required Rails 8.x)
- ✅ No client-side state management added
- ✅ No GraphQL added
- ✅ Uses Rails conventions (initializers, concerns, standard logger)

## Project Structure

### Documentation (this feature)

```text
specs/018-structured-events/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output (minimal - no database entities)
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output (event schemas)
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
app/
├── controllers/
│   └── concerns/
│       └── event_context.rb          # NEW: Sets request context for events
├── subscribers/                       # NEW: Directory for event subscribers
│   └── event_log_subscriber.rb       # NEW: Formats events as JSON for logging
config/
└── initializers/
    └── events.rb                      # NEW: Registers event subscribers

# Files to modify (add event emission):
app/controllers/application_controller.rb
app/controllers/email_subscriptions_controller.rb
app/controllers/cart_items_controller.rb
app/controllers/checkouts_controller.rb
app/controllers/pending_orders_controller.rb
app/controllers/reorder_schedules_controller.rb
app/controllers/webhooks/stripe_controller.rb
app/jobs/create_pending_orders_job.rb
app/services/pending_order_confirmation_service.rb

# Tests:
test/subscribers/event_log_subscriber_test.rb    # NEW
test/integration/event_emission_test.rb          # NEW
```

**Structure Decision**: Standard Rails structure extended with `app/subscribers/` for event subscriber classes, following Rails convention of domain-specific directories under `app/`.

## Complexity Tracking

> No violations requiring justification. Implementation uses standard Rails patterns.

| Item | Decision | Rationale |
|------|----------|-----------|
| Subscriber location | `app/subscribers/` | Follows Rails convention for domain-specific classes; autoloaded |
| Context via concern | `EventContext` concern | Reusable across controllers; included in ApplicationController |
| No middleware | Direct `before_action` | Simpler than custom middleware; transparent behavior |
