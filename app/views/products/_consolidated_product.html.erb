<%# Template for consolidated products (napkins, straws, etc.) with material/colour configurator %>

<% content_for :title do %>
<%= @product.meta_title.presence || "#{@product.name} | #{@product.category.name} | Afida" %>
<% end %>

<% content_for :meta_description do %>
<%= @product.meta_description.presence || @product.description_standard_with_fallback %>
<% end %>

<% content_for :head do %>
  <!-- Twitter Card meta tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="<%= @product.name %>">
  <meta name="twitter:description" content="<%= @product.description_standard_with_fallback %>">
  <% if @selected_variant&.primary_photo&.attached? %>
    <meta name="twitter:image" content="<%= polymorphic_url(@selected_variant.primary_photo.variant(resize_to_limit: [1200, 630])) %>">
  <% end %>

  <!-- Open Graph meta tags -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="<%= @product.name %>">
  <meta property="og:description" content="<%= @product.description_standard_with_fallback %>">
  <meta property="og:url" content="<%= polymorphic_url(@product) %>">
  <meta property="og:site_name" content="Afida">
  <% if @selected_variant&.primary_photo&.attached? %>
    <meta property="og:image" itemprop="image" content="<%= polymorphic_url(@selected_variant.primary_photo.variant(resize_to_limit: [800, 600])) %>">
    <meta property="og:image:width" content="800">
    <meta property="og:image:height" content="600">
    <meta property="og:image:alt" content="<%= @product.name %>">
  <% end %>

  <script type="application/ld+json">
    <%= raw product_structured_data(@product, @selected_variant) %>
  </script>

  <script type="application/ld+json">
    <%= raw breadcrumb_structured_data([
      { name: "Home", url: root_url },
      { name: @product.category.name, url: category_url(@product.category) },
      { name: @product.name, url: product_url(@product) }
    ]) %>
  </script>

  <%# GA4 E-commerce: view_item event %>
  <script>
    <%= ecommerce_view_item_event(@product, @selected_variant) %>
  </script>
<% end %>

<% content_for :breadcrumbs do %>
  <%= render "shared/breadcrumbs", product: @product %>
<% end %>

<div class="drawer drawer-end">
  <input id="cart-drawer" type="checkbox" class="drawer-toggle" aria-label="Toggle shopping cart" />
  <div class="drawer-content">
    <div class="container mx-auto min-h-screen py-4 pb-24 lg:pb-8">

      <%# ===== PURCHASE ZONE ===== %>
      <%
        option_order = @configurator_options.keys
        pac_size = @selected_variant&.pac_size || @product.active_variants.first&.pac_size || 1
      %>
      <div class="flex flex-col lg:flex-row gap-8 lg:gap-12"
           data-controller="product-configurator"
           data-product-configurator-variants-value="<%= @variants_json.to_json %>"
           data-product-configurator-option-order-value="<%= option_order.to_json %>"
           data-product-configurator-pac-size-value="<%= pac_size %>"
           data-product-configurator-min-price-value="<%= @min_price.to_f %>">

        <%# Image Section %>
        <div class="lg:w-1/2 flex-shrink-0">
          <div class="bg-white rounded-lg overflow-hidden">
            <%= product_photo_tag(@selected_variant.primary_photo,
                                  alt: @product.name,
                                  class: "w-full h-auto object-contain",
                                  variant: { resize_and_pad: [800, 800, { background: [255, 255, 255] }] },
                                  fetchpriority: "high",
                                  width: 800,
                                  height: 800,
                                  data: { product_configurator_target: "imageDisplay" }) %>
          </div>
        </div>

        <%# Content Section %>
        <div class="lg:w-1/2 text-center lg:text-left">

          <%# Title %>
          <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold">
            <%= @product.name %>
          </h1>

          <%# SKU - hidden until variant selected, shown directly under title %>
          <p class="text-sm text-base-content/50 font-mono mt-1 text-center lg:text-left" data-product-configurator-target="skuDisplay" style="display: none;">
          </p>

          <%# Price Display - hidden until variant selected %>
          <p class="text-xl text-black mt-3 text-center lg:text-left" data-product-configurator-target="unitPriceDisplay" style="display: none;">
          </p>

          <%# Short Description %>
          <% if @product.description_standard_with_fallback.present? %>
            <p class="text-lg text-gray-700 mt-4">
              <%= @product.description_standard_with_fallback %>
            </p>
          <% end %>

          <%# Configurator - handles option selection and add to cart %>
          <%= render "products/configurator" %>

        </div>
      </div>

      <%# ===== PRODUCT DETAILS ZONE ===== %>
      <div class="mt-12 space-y-8">

        <%# About / Detailed Description %>
        <% if @product.description_detailed_with_fallback.present? %>
          <section>
            <h2 class="text-xl font-semibold mb-4">About Our <%= @product.name %></h2>
            <div class="prose prose-lg max-w-none text-base-content/80">
              <%= simple_format(@product.description_detailed_with_fallback) %>
            </div>
          </section>
        <% end %>

      </div>

      <%# ===== RELATED PRODUCTS ZONE ===== %>
      <% if @related_products&.any? %>
        <section class="mt-12 py-8" data-controller="related-products">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-semibold">You May Also Like</h2>
            <div class="flex gap-1">
              <button type="button" class="btn btn-ghost btn-sm btn-circle" data-action="related-products#scrollLeft" aria-label="Scroll left">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
              </button>
              <button type="button" class="btn btn-ghost btn-sm btn-circle" data-action="related-products#scrollRight" aria-label="Scroll right">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </button>
            </div>
          </div>

          <div class="flex gap-4 overflow-x-auto pb-4 scrollbar-hide" data-related-products-target="container">
            <% @related_products.each do |product| %>
              <div class="flex-shrink-0 w-[calc(50%-8px)] sm:w-[calc(33.333%-11px)] lg:w-[calc(25%-12px)]">
                <%= render "products/card", product: product, show_quick_add: true %>
              </div>
            <% end %>
          </div>
        </section>
      <% end %>

    </div>
  </div>

  <div class="drawer-side">
    <label for="cart-drawer" aria-label="Close cart drawer" class="drawer-overlay"></label>
    <div class="bg-base-200 text-base-content h-full w-80 p-4 flex flex-col">
      <%= render "shared/drawer_cart_content" %>
    </div>
  </div>
</div>
