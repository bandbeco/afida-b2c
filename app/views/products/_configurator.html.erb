<%# Configurator for consolidated products with dynamic option filtering %>
<%# Uses product_configurator_controller.js for sparse matrix handling %>
<%# NOTE: The controller wrapper is in _consolidated_product.html.erb to encompass all targets %>

<%
  pac_size = @selected_variant&.pac_size || @product.active_variants.first&.pac_size || 1
%>

<%# Option Groups %>
  <div class="space-y-4 mt-6">
    <% @configurator_options.each do |option_name, values| %>
      <div class="w-full"
           data-product-configurator-target="optionGroup"
           data-option-name="<%= option_name %>">
        <label class="block text-sm font-semibold mb-2">
          Select <%= option_name.downcase %>:
        </label>
        <div class="flex flex-wrap justify-center lg:justify-start gap-2">
          <% values.each do |value| %>
            <button type="button"
                    class="relative bg-white border-2 border-gray-300 text-black hover:border-primary rounded-lg px-3 py-2 sm:px-6 sm:py-3 cursor-pointer font-medium text-sm sm:text-base transition-colors"
                    data-option-button
                    data-option-name="<%= option_name %>"
                    data-value="<%= value %>"
                    data-action="click->product-configurator#selectOption">
              <%= value %>
              <span class="option-checkmark hidden absolute -top-1.5 -right-1.5 sm:-top-2 sm:-right-2 w-5 h-5 sm:w-6 sm:h-6 bg-primary rounded-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 sm:w-4 sm:h-4 text-white" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
              </span>
            </button>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <%# Purchase Form %>
  <div class="mt-6">
    <%= form_with url: cart_cart_items_path, method: :post, class: "w-full space-y-4", local: false, data: { controller: "cart-drawer", action: "turbo:submit-end->cart-drawer#open", product_configurator_target: "form" } do |f| %>
      <input type="hidden"
             name="cart_item[variant_sku]"
             value=""
             data-product-configurator-target="variantSkuInput" />

      <%# Quantity Select %>
      <div class="form-control">
        <div class="flex justify-between items-baseline mb-2">
          <label for="cart_item_quantity" class="text-sm font-semibold">Select quantity:</label>
          <span class="text-sm text-base-content/60" data-product-configurator-target="packSizeDisplay">
            Pack size: <%= number_with_delimiter(pac_size) %> units
          </span>
        </div>
        <%= select_tag "cart_item[quantity]",
                        options_for_select((1..10).map { |num_packs| ["#{num_packs} #{num_packs == 1 ? 'pack' : 'packs'} (#{number_with_delimiter(num_packs * pac_size)} units)", num_packs] }, 1),
                        id: "cart_item_quantity",
                        class: "select select-bordered select-lg w-full",
                        data: { product_configurator_target: "quantitySelect", action: "change->product-configurator#updateQuantity" } %>
      </div>

      <%# Delivery Info & Total %>
      <div class="mt-6 space-y-2">
        <div class="flex items-center gap-2 justify-center lg:justify-start">
          <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
          </svg>
          <span class="font-medium text-sm sm:text-base">Delivered in 2 to 3 working days</span>
        </div>
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 pt-4 border-t border-base-200">
          <p class="text-base sm:text-lg">Total (excl. VAT)</p>
          <p class="text-xl sm:text-2xl font-semibold" data-product-configurator-target="priceDisplay">
            Price: TBD
          </p>
        </div>
      </div>

      <%# Add to Cart Button (Desktop) %>
      <%= f.submit "Add to cart", class: "btn btn-primary btn-lg w-full cursor-pointer hidden lg:flex btn-disabled", disabled: true, data: { product_configurator_target: "addToCartButton" } %>
      <p class="text-sm text-base-content/60 text-center mt-3 hidden lg:flex items-center justify-center gap-1.5">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
        </svg>
        Free delivery over Â£100
      </p>
    <% end %>
  </div>

  <%# Mobile Sticky Add to Cart Bar %>
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-base-200 p-3 lg:hidden z-40 shadow-lg"
       data-product-configurator-target="mobileBar">
    <div class="flex items-center justify-between gap-4 max-w-lg mx-auto">
      <div>
        <p class="text-lg font-semibold" data-product-configurator-target="mobilePriceDisplay">
          TBD
        </p>
        <p class="text-xs text-base-content/60">excl. VAT</p>
      </div>
      <button type="button"
              class="btn btn-primary flex-1 max-w-[200px] btn-disabled"
              disabled
              data-product-configurator-target="addToCartButton"
              data-action="click->product-configurator#submitForm">
        Add to Cart
      </button>
    </div>
  </div>
