<%#
  Product Show Page
  Phase 1: One page per product (formerly variant)

  Uses: quantity-selector controller for simple quantity selection
  Data: @product, @related_products
%>

<% content_for :title do %>
<%= @product.meta_title.presence || "#{@product.generated_title} | #{@product.category.name} | Afida" %>
<% end %>

<% content_for :meta_description do %>
<%= @product.meta_description.presence || @product.description_standard_with_fallback %>
<% end %>

<% content_for :head do %>
  <!-- Twitter Card meta tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="<%= @product.generated_title %>">
  <meta name="twitter:description" content="<%= @product.description_standard_with_fallback %>">
  <% if @product&.primary_photo&.attached? %>
    <meta name="twitter:image" content="<%= polymorphic_url(@product.primary_photo.variant(resize_to_limit: [1200, 630])) %>">
  <% end %>

  <!-- Open Graph meta tags -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="<%= @product.generated_title %>">
  <meta property="og:description" content="<%= @product.description_standard_with_fallback %>">
  <meta property="og:url" content="<%= polymorphic_url(@product) %>">
  <meta property="og:site_name" content="Afida">
  <% if @product&.primary_photo&.attached? %>
    <meta property="og:image" itemprop="image" content="<%= polymorphic_url(@product.primary_photo.variant(resize_to_limit: [800, 600])) %>">
  <% end %>
  <meta property="product:price:amount" content="<%= @product.price %>">
  <meta property="product:price:currency" content="GBP">

  <script type="application/ld+json">
    <%= raw product_structured_data(@product) %>
  </script>

  <script type="application/ld+json">
    <%= raw breadcrumb_structured_data([
      { name: "Home", url: root_url },
      { name: @product.category.name, url: category_url(@product.category) },
      { name: @product.generated_title, url: product_url(@product) }
    ]) %>
  </script>

  <%# GA4 E-commerce: view_item event %>
  <script>
    <%= ecommerce_view_item_event(@product) %>
  </script>
<% end %>

<% content_for :breadcrumbs do %>
  <%= render "shared/breadcrumbs", product: @product %>
<% end %>

<div class="drawer drawer-end">
  <input id="cart-drawer" type="checkbox" class="drawer-toggle" aria-label="Toggle shopping cart" />

  <div class="drawer-content">
    <div class="container mx-auto min-h-screen py-4 pb-8">

      <div class="flex flex-col lg:flex-row gap-8 lg:gap-12">

        <%# Image Section %>
        <div class="lg:w-1/2 flex-shrink-0">
          <div class="bg-white rounded-lg overflow-hidden">
            <%= product_photo_tag(@product.primary_photo,
                                  alt: @product.generated_title,
                                  class: "w-full h-auto object-contain",
                                  variant: { resize_and_pad: [800, 800, { background: [255, 255, 255] }] },
                                  fetchpriority: "high",
                                  width: 800,
                                  height: 800) %>
          </div>
        </div>

        <%# Content Section %>
        <div class="lg:w-1/2 text-center lg:text-left"
             data-controller="quantity-selector"
             data-quantity-selector-price-value="<%= @product.price.to_f %>"
             data-quantity-selector-pac-size-value="<%= @product.pac_size || 1 %>">

          <h1 class="text-2xl sm:text-3xl lg:text-4xl">
            <%= @product.generated_title %>
          </h1>

          <%# Price Display %>
          <div class="flex items-center justify-center lg:justify-start gap-2 flex-wrap mt-3">
            <p class="text-xl font-semibold">
              <% if @product.pac_size && @product.pac_size > 1 %>
                <%= number_to_currency(@product.price) %> / pack of <%= number_with_delimiter(@product.pac_size) %>
              <% else %>
                <%= number_to_currency(@product.price) %>
              <% end %>
            </p>
          </div>


          <%# SKU %>
          <div class="mt-2">
            <span class="text-sm text-base-content/50 font-mono">
              SKU: <%= @product.sku %>
            </span>
          </div>

          <%# Short Description %>
          <% if @product.description_standard_with_fallback.present? %>
            <p class="text-lg text-gray-700 mt-4">
              <%= @product.description_standard_with_fallback %>
            </p>
          <% end %>

          <%# Quantity Selector %>
          <div class="mt-6">
            <label for="quantity" class="block text-lg font-medium mb-2">Quantity</label>
            <div class="flex items-center justify-center lg:justify-start gap-4">
              <div class="join">
                <button type="button"
                        class="join-item btn btn-outline"
                        data-action="click->quantity-selector#decrement"
                        aria-label="Decrease quantity">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                  </svg>
                </button>
                <input type="number"
                       id="quantity"
                       name="quantity"
                       value="1"
                       min="1"
                       max="999"
                       class="join-item input input-bordered w-20 text-center"
                       data-quantity-selector-target="input"
                       data-action="change->quantity-selector#updateTotal"
                       aria-label="Quantity">
                <button type="button"
                        class="join-item btn btn-outline"
                        data-action="click->quantity-selector#increment"
                        aria-label="Increase quantity">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  </svg>
                </button>
              </div>
              <% if @product.pac_size && @product.pac_size > 1 %>
                <span class="text-base-content/60" data-quantity-selector-target="unitsDisplay">
                  (<%= number_with_delimiter(@product.pac_size) %> units)
                </span>
              <% end %>
            </div>
          </div>

          <%# Custom Inquiry CTA %>
          <div class="mt-6">
            <div class="bg-base-200 rounded-lg p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <div>
                <p class="font-sm">Can't find what you're looking for?</p>
                <p class="text-xs">Need a different size, quantity, or material ...</p>
              </div>
              <%= link_to "Get in touch", contact_path, class: "link link-hover underline font-medium whitespace-nowrap" %>
            </div>
          </div>

          <%# Order Summary & Add to Cart %>
          <div class="mt-6 space-y-2">
            <div class="flex items-center gap-2 justify-center lg:justify-start">
              <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
              </svg>
              <span class="text-sm sm:text-base">Delivered in 2 to 3 working days</span>
            </div>

            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 pt-4 border-t border-base-200">
              <p class="text-base sm:text-lg">Total (excl. VAT)</p>
              <p class="text-xl sm:text-2xl" data-quantity-selector-target="totalDisplay">
                <%= number_to_currency(@product.price) %>
              </p>
            </div>
          </div>

          <%# Add to Cart Form %>
          <%= form_with url: cart_cart_items_path,
                        method: :post,
                        data: { controller: "cart-drawer", action: "turbo:submit-end->cart-drawer#open", turbo: true },
                        class: "mt-4" do |f| %>
            <%= hidden_field_tag "cart_item[sku]", @product.sku %>
            <input type="hidden"
                   name="cart_item[quantity]"
                   data-quantity-selector-target="quantityInput"
                   value="1" />
            <button type="submit" class="btn btn-primary btn-lg w-full">
              Add to Cart
            </button>
          <% end %>

          <p class="text-sm text-base-content/60 text-center mt-3 flex items-center justify-center gap-1.5">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
            </svg>
            Free delivery over Â£100
          </p>

        </div>
      </div>

      <%# Product Details Section %>
      <% if @product.description_detailed_with_fallback.present? %>
        <div class="mt-12 space-y-8">
          <div class="prose max-w-none">
            <h2>Product Details</h2>
            <p><%= @product.description_detailed_with_fallback %></p>
          </div>
        </div>
      <% end %>

      <%# Related Products Section %>
      <% if @related_products.any? %>
        <div class="mt-12">
          <h2 class="text-2xl mb-6">Related Products</h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <%= render partial: "products/card", collection: @related_products, as: :product %>
          </div>
        </div>
      <% end %>

    </div>
  </div>

  <%# Cart Drawer %>
  <div class="drawer-side z-50">
    <label for="cart-drawer" aria-label="Close cart drawer" class="drawer-overlay"></label>
    <div class="bg-base-200 text-base-content h-full w-80 p-4 flex flex-col">
      <%= render "shared/drawer_cart_content" %>
    </div>
  </div>

</div>
