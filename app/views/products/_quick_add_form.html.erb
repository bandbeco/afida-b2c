<%# Quick Add Form - Handles both single and multi-variant products %>

<% variants_data ||= @variants_json || [] %>
<% product_options ||= @product_options || [] %>
<% option_labels ||= @option_labels || {} %>

<%= form_with url: cart_cart_items_path,
              method: :post,
              class: "space-y-4",
              data: {
                controller: "cart-drawer quick-add-form",
                action: "turbo:submit-end->cart-drawer#open",
                quick_add_form_variants_data_value: variants_data.to_json
              } do |f| %>

  <%# Hidden field for variant SKU - will be updated by Stimulus when options change %>
  <%= hidden_field_tag "cart_item[variant_sku]",
                       (variants.first&.sku || product.default_variant&.sku),
                       data: { quick_add_form_target: "variantSku" } %>

  <%# Option selectors - Same UI as product detail page %>
  <% if variants.count > 1 && product_options.any? %>
    <div class="space-y-3">
      <% product_options.each do |option| %>
        <%
          # Get unique values for this option from all variants
          option_values = variants.map { |v| v.option_values[option.name] }.compact.uniq
          # Sort by numeric value if present
          option_values = option_values.sort_by { |v| v.scan(/\d+/).first.to_i }
          selected_value = variants.first.option_values[option.name]
          target_name = option.name.downcase
        %>
        <div class="form-control">
          <label class="label pb-2">
            <span class="label-text font-semibold">Select <%= option.name.downcase %>:</span>
          </label>
          <div class="flex flex-wrap gap-2">
            <% option_values.each do |value| %>
              <button type="button"
                      class="relative bg-white border-2 border-gray-300 text-black hover:border-primary rounded-lg px-4 py-2 cursor-pointer font-medium text-sm <%= 'border-primary' if value == selected_value %>"
                      data-quick-add-form-target="<%= target_name %>Button"
                      data-option="<%= option.name %>"
                      data-value="<%= value %>"
                      data-action="click->quick-add-form#selectOption">
                <%= option_labels.dig(option.name, value) || value %>
                <% if value == selected_value %>
                  <span class="option-checkmark absolute -top-2 -right-2 w-5 h-5 bg-primary rounded-full flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-white" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                  </span>
                <% end %>
              </button>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <%# Quantity selector - Show multiples of pack size %>
  <% pac_size = (variants.first&.pac_size || product.default_variant&.pac_size || 1) %>
  <div class="form-control">
    <label class="label">
      <span class="label-text font-semibold">Select quantity:</span>
      <span class="label-text-alt text-sm text-base-content/60" data-quick-add-form-target="packSizeDisplay">
        Pack size: <%= number_with_delimiter(pac_size) %> units
      </span>
    </label>
    <%# Value is number of packs, display shows "X packs (Y units)" %>
    <%= select_tag "cart_item[quantity]",
                   options_for_select((1..10).map { |num_packs|
                     total_units = num_packs * pac_size
                     ["#{num_packs} #{num_packs == 1 ? 'pack' : 'packs'} (#{number_with_delimiter(total_units)} units)", num_packs]
                   }, 1),
                   class: "select select-bordered w-full",
                   data: {
                     quick_add_form_target: "quantitySelect",
                     action: "change->quick-add-form#updatePrice"
                   } %>
  </div>

  <%# Price display - Shows selected variant price %>
  <div class="flex justify-between items-center py-3 px-4 bg-base-200 rounded-lg">
    <span class="font-medium">Price:</span>
    <span class="font-semibold text-lg" data-quick-add-form-target="priceDisplay">
      <%= number_to_currency(variants.first&.price || product.default_variant&.price || 0) %>
    </span>
  </div>

  <%# Submit button %>
  <%= f.submit "Add to Cart", class: "btn btn-primary w-full mt-4" %>
<% end %>
