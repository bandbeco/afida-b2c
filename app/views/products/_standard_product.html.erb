<% unless @selected_variant %>
  <div class="container mx-auto px-4 py-8">
    <div class="alert alert-warning">
      <span>This product is currently unavailable.</span>
    </div>
    <%= link_to "Back to Products", products_path, class: "btn btn-primary mt-4" %>
  </div>
  <% return %>
<% end %>

<% content_for :title do %>
<%= @product.meta_title.presence || "#{@product.name} | #{@product.category.name} | Afida" %>
<% end %>

<% content_for :meta_description do %>
<%= @product.meta_description.presence || @product.description_standard_with_fallback %>
<% end %>

<% content_for :head do %>
  <!-- Twitter Card meta tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="<%= @product.name %>">
  <meta name="twitter:description" content="<%= @product.description_standard_with_fallback %>">
  <% if @selected_variant&.primary_photo&.attached? %>
    <meta name="twitter:image" content="<%= polymorphic_url(@selected_variant.primary_photo.variant(resize_to_limit: [1200, 630])) %>">
  <% end %>

  <!-- Open Graph meta tags (also used by Twitter and WhatsApp) -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="<%= @product.name %>">
  <meta property="og:description" content="<%= @product.description_standard_with_fallback %>">
  <meta property="og:url" content="<%= polymorphic_url(@product) %>">
  <meta property="og:site_name" content="Afida">
  <% if @selected_variant&.primary_photo&.attached? %>
    <meta property="og:image" itemprop="image" content="<%= polymorphic_url(@selected_variant.primary_photo.variant(resize_to_limit: [800, 600])) %>">
    <meta property="og:image:width" content="800">
    <meta property="og:image:height" content="600">
    <meta property="og:image:alt" content="<%= @product.name %>">
  <% end %>
  <% if @selected_variant %>
    <meta property="product:price:amount" content="<%= @selected_variant.price %>">
    <meta property="product:price:currency" content="GBP">
  <% end %>

  <script type="application/ld+json">
    <%= raw product_structured_data(@product, @selected_variant) %>
  </script>

  <script type="application/ld+json">
    <%= raw breadcrumb_structured_data([
      { name: "Home", url: root_url },
      { name: @product.category.name, url: category_url(@product.category) },
      { name: @product.name, url: product_url(@product) }
    ]) %>
  </script>

  <%# GA4 E-commerce: view_item event %>
  <script>
    <%= ecommerce_view_item_event(@product, @selected_variant) %>
  </script>
<% end %>

<% content_for :breadcrumbs do %>
  <%= render "shared/breadcrumbs", product: @product %>
<% end %>

<%
  pac_size = @selected_variant.pac_size || 1
%>

<div class="drawer drawer-end">
  <input id="cart-drawer" type="checkbox" class="drawer-toggle" aria-label="Toggle shopping cart" />
  <div class="drawer-content">
    <div class="container mx-auto min-h-screen py-4 pb-24 lg:pb-8">

      <%# ===== PURCHASE ZONE ===== %>
      <div class="flex flex-col lg:flex-row gap-8 lg:gap-12"
           data-controller="product-options"
           data-product-options-variants-value="<%= @variants_json.to_json %>"
           data-product-options-pac-size-value="<%= pac_size %>"
           data-product-options-min-price-value="<%= @min_price.to_f %>"
           data-product-options-has-selection-value="<%= @has_url_selection.to_s %>">

        <%# Image Section - No card wrapper %>
        <div class="lg:w-1/2 flex-shrink-0">
          <div class="bg-white rounded-lg overflow-hidden">
            <%= product_photo_tag(@selected_variant.primary_photo,
                                  alt: @product.name,
                                  class: "w-full h-auto object-contain",
                                  variant: { resize_and_pad: [800, 800, { background: [255, 255, 255] }] },
                                  fetchpriority: "high",
                                  width: 800,
                                  height: 800,
                                  data: { product_options_target: "imageDisplay" }) %>
          </div>
        </div>

        <%# Content Section - No card-body %>
        <div class="lg:w-1/2 text-center lg:text-left">

          <%# Title %>
          <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold">
            <%= @product.name %>
          </h1>

          <%# Price with Free Delivery Badge %>
          <div class="flex items-center justify-center lg:justify-start gap-2 flex-wrap mt-3">
            <p class="text-xl text-black" data-product-options-target="unitPriceDisplay">
              <% if @has_url_selection %>
                <%= number_to_currency(@selected_variant.price) %> / pack
              <% else %>
                from <%= number_to_currency(@min_price) %> / pack
              <% end %>
            </p>
          </div>

          <%# Colour & SKU %>
          <div class="flex items-center justify-center lg:justify-start gap-3 mt-2">
            <% if @product.colour.present? %>
              <span class="text-base-content/60 font-medium text-lg"><%= @product.colour %></span>
            <% end %>
            <span class="text-sm text-base-content/50 font-mono" data-product-options-target="skuDisplay" style="<%= 'display: none;' unless @has_url_selection %>">
              SKU: <%= @selected_variant.sku %>
            </span>
          </div>

          <%# Short Description %>
          <% if @product.description_standard_with_fallback.present? %>
            <p class="text-lg text-gray-700 mt-4">
              <%= @product.description_standard_with_fallback %>
            </p>
          <% end %>

          <%# Variant Options %>
          <% if @product.active_variants.count > 1 %>
            <div class="space-y-4 mt-6">
              <% @product_options.each do |option| %>
                <div class="w-full">
                  <label class="block text-sm font-semibold mb-2">
                    Select <%= option.name.downcase %>:
                  </label>
                  <%
                    option_values = @product.active_variants.map { |v| v.option_values[option.name] }.compact.uniq
                    option_values = option_values.sort_by { |v| v.scan(/\d+/).first.to_i }
                    selected_value = @selected_variant.option_values[option.name]
                    target_name = option.name.downcase
                  %>
                  <div class="flex flex-wrap justify-center lg:justify-start gap-2">
                    <% option_values.each do |value| %>
                      <button type="button"
                              class="relative bg-white border-2 border-gray-300 text-black hover:border-primary rounded-lg px-3 py-2 sm:px-6 sm:py-3 cursor-pointer font-medium text-sm sm:text-base transition-colors"
                              data-product-options-target="<%= target_name %>Button"
                              data-value="<%= value %>"
                              data-action="click->product-options#select<%= option.name.capitalize %>">
                        <%= @option_labels.dig(option.name, value) || value %>
                        <span class="option-checkmark hidden absolute -top-1.5 -right-1.5 sm:-top-2 sm:-right-2 w-5 h-5 sm:w-6 sm:h-6 bg-primary rounded-full flex items-center justify-center">
                          <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 sm:w-4 sm:h-4 text-white" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                          </svg>
                        </span>
                      </button>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>

          <%# Purchase Form %>
          <div class="mt-6">
            <%= form_with url: cart_cart_items_path, method: :post, class: "w-full space-y-4", local: false, data: { controller: "cart-drawer", action: "turbo:submit-end->cart-drawer#open", product_options_target: "form" } do |f| %>
              <input type="hidden"
                     name="cart_item[variant_sku]"
                     value="<%= @selected_variant.sku %>"
                     data-product-options-target="variantSkuInput" />

              <%# Quantity Select %>
              <div class="form-control">
                <div class="flex justify-between items-baseline mb-2">
                  <label for="cart_item_quantity" class="text-sm font-semibold">Select quantity:</label>
                  <span class="text-sm text-base-content/60" data-product-options-target="packSizeDisplay">
                    Pack size: <%= number_with_delimiter(pac_size) %> units
                  </span>
                </div>
                <%= select_tag "cart_item[quantity]",
                                options_for_select((1..10).map { |num_packs| ["#{num_packs} #{num_packs == 1 ? 'pack' : 'packs'} (#{number_with_delimiter(num_packs * pac_size)} units)", num_packs] }, 1),
                                id: "cart_item_quantity",
                                class: "select select-bordered select-lg w-full",
                                data: { product_options_target: "quantitySelect", action: "change->product-options#updateQuantity" } %>
              </div>

              <%# Compatible Lids Section - Mini Carousel %>
              <% if @product.name.downcase.include?('cup') && !@product.name.downcase.include?('lid') && @product.has_compatible_lids? %>
                <div class="mt-6"
                     data-controller="compatible-lids"
                     data-compatible-lids-product-id-value="<%= @product.id %>"
                     data-action="product-options:variant-changed@window->compatible-lids#onVariantChanged product-options:quantity-changed@window->compatible-lids#onQuantityChanged">

                  <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-semibold">Add a matching lid</h3>
                    <div class="flex gap-1">
                      <button type="button" class="btn btn-ghost btn-xs btn-circle" data-action="compatible-lids#scrollLeft" aria-label="Scroll left">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                      </button>
                      <button type="button" class="btn btn-ghost btn-xs btn-circle" data-action="compatible-lids#scrollRight" aria-label="Scroll right">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                      </button>
                    </div>
                  </div>

                  <!-- Loading State -->
                  <div data-compatible-lids-target="loading" style="display: none;" class="text-center py-4">
                    <span class="loading loading-spinner loading-md"></span>
                    <p class="text-base-content/60 text-sm mt-2">Loading compatible lids...</p>
                  </div>

                  <!-- Lids Carousel Container -->
                  <div data-compatible-lids-target="container" class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
                    <!-- Lids will be loaded here dynamically as compact cards -->
                  </div>
                </div>
              <% end %>

              <%# Delivery Info & Total %>
              <div class="mt-6 space-y-2">
                <div class="flex items-center gap-2 justify-center lg:justify-start">
                  <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                  </svg>
                  <span class="font-medium text-sm sm:text-base">Delivered in 2 to 3 working days</span>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 pt-4 border-t border-base-200">
                  <p class="text-base sm:text-lg">Total (excl. VAT)</p>
                  <p class="text-xl sm:text-2xl font-semibold" data-product-options-target="priceDisplay">
                    <% if @has_url_selection %>
                      <%= number_to_currency(@selected_variant.price) %>
                    <% else %>
                      <%= number_to_currency(@min_price) %>
                    <% end %>
                  </p>
                </div>
              </div>

              <%# Add to Cart Button (Desktop) %>
              <%= f.submit "Add to cart", class: "btn btn-primary btn-lg w-full cursor-pointer hidden lg:flex", data: { product_options_target: "addToCartButton" } %>
              <p class="text-sm text-base-content/60 text-center mt-3 hidden lg:flex items-center justify-center gap-1.5">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                </svg>
                Free delivery over Â£100
              </p>
            <% end %>
          </div>

        </div>
      </div>

      <%# ===== PRODUCT DETAILS ZONE (Full Width) ===== %>
      <div class="mt-12 space-y-8">

        <%# About / Detailed Description %>
        <% if @product.description_detailed_with_fallback.present? %>
          <section>
            <h2 class="text-xl font-semibold mb-4">About Our <%= @product.name %></h2>
            <div class="prose prose-lg max-w-none text-base-content/80">
              <%= simple_format(@product.description_detailed_with_fallback) %>
            </div>
          </section>
        <% end %>

        <%# Specifications Grid %>
        <% if @selected_variant.variant_attributes.any? %>
          <section>
            <h2 class="text-xl font-semibold mb-4">Specifications</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
              <% @selected_variant.variant_attributes.each do |key, value| %>
                <div class="bg-base-100 border border-base-200 rounded-lg p-4">
                  <p class="text-xs text-base-content/60 uppercase tracking-wide"><%= key.to_s.humanize %></p>
                  <p class="font-medium mt-1"><%= value %></p>
                </div>
              <% end %>
            </div>
          </section>
        <% end %>

      </div>

      <%# ===== RELATED PRODUCTS ZONE ===== %>
      <% if @related_products&.any? %>
        <section class="mt-12 py-8" data-controller="related-products">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-semibold">You May Also Like</h2>
            <div class="flex gap-1">
              <button type="button" class="btn btn-ghost btn-sm btn-circle" data-action="related-products#scrollLeft" aria-label="Scroll left">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
              </button>
              <button type="button" class="btn btn-ghost btn-sm btn-circle" data-action="related-products#scrollRight" aria-label="Scroll right">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </button>
            </div>
          </div>

          <div class="flex gap-4 overflow-x-auto pb-4 scrollbar-hide" data-related-products-target="container">
            <% @related_products.each do |product| %>
              <div class="flex-shrink-0 w-[calc(50%-8px)] sm:w-[calc(33.333%-11px)] lg:w-[calc(25%-12px)]">
                <%= render "products/card", product: product, show_quick_add: true %>
              </div>
            <% end %>
          </div>
        </section>
      <% end %>

    </div>
  </div>

  <%# Mobile Sticky Add to Cart Bar %>
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-base-200 p-3 lg:hidden z-40 shadow-lg"
       data-product-options-target="mobileBar">
    <div class="flex items-center justify-between gap-4 max-w-lg mx-auto">
      <div>
        <p class="text-lg font-semibold" data-product-options-target="mobilePriceDisplay">
          <% if @has_url_selection %>
            <%= number_to_currency(@selected_variant.price) %>
          <% else %>
            <%= number_to_currency(@min_price) %>
          <% end %>
        </p>
        <p class="text-xs text-base-content/60">excl. VAT</p>
      </div>
      <button type="button"
              class="btn btn-primary flex-1 max-w-[200px]"
              data-action="click->product-options#submitForm">
        Add to Cart
      </button>
    </div>
  </div>

  <div class="drawer-side">
    <label for="cart-drawer" aria-label="Close cart drawer" class="drawer-overlay"></label>
    <div class="bg-base-200 text-base-content h-full w-80 p-4 flex flex-col">
      <%= render "shared/drawer_cart_content" %>
    </div>
  </div>
</div>
