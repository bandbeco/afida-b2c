<%# Product Variant Page - Individual SKU page for direct purchasing %>

<% content_for :title do %>
  <%= @variant.full_name %> | Afida
<% end %>

<% content_for :meta_description do %>
  <%= @variant.variant_meta_description %>
<% end %>

<% content_for :head do %>
  <%# Canonical URL %>
  <%= canonical_url(product_variant_url(@variant.slug)) %>

  <%# Product Structured Data (JSON-LD) %>
  <script type="application/ld+json">
    <%= raw variant_structured_data(@variant) %>
  </script>

  <%# Breadcrumb Structured Data %>
  <script type="application/ld+json">
    <%= raw breadcrumb_structured_data([
      { name: "Home", url: root_url },
      { name: @category.name, url: category_url(@category) },
      { name: @variant.full_name, url: product_variant_url(@variant.slug) }
    ]) %>
  </script>
<% end %>

<div class="container mx-auto px-4 py-8">
  <%# Breadcrumb navigation %>
  <nav aria-label="Breadcrumb" class="mb-6">
    <ol class="flex items-center space-x-2 text-sm text-gray-600">
      <li>
        <%= link_to "Home", root_path, class: "hover:text-gray-900" %>
      </li>
      <li class="flex items-center">
        <span class="mx-2">/</span>
        <%= link_to @category.name, category_path(@category), class: "hover:text-gray-900" %>
      </li>
      <li class="flex items-center">
        <span class="mx-2">/</span>
        <span class="text-gray-900 font-medium"><%= @variant.full_name %></span>
      </li>
    </ol>
  </nav>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <%# Product Image %>
    <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden">
      <% if @variant.primary_photo&.attached? %>
        <%= image_tag @variant.primary_photo, class: "w-full h-full object-cover", alt: @variant.full_name %>
      <% elsif @product.primary_photo&.attached? %>
        <%= image_tag @product.primary_photo, class: "w-full h-full object-cover", alt: @variant.full_name %>
      <% else %>
        <div class="w-full h-full flex items-center justify-center text-gray-400">
          <svg class="w-24 h-24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
      <% end %>
    </div>

    <%# Product Details %>
    <div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2"><%= @variant.full_name %></h1>

      <% if @variant.options_summary.present? %>
        <p class="text-gray-600 mb-4"><%= @variant.options_summary %></p>
      <% end %>

      <%# Price Display %>
      <div class="mb-6">
        <p class="text-2xl font-bold text-gray-900">
          <%= number_to_currency(@variant.price) %>
          <span class="text-base font-normal text-gray-600">/ pack</span>
        </p>
        <% if @variant.pac_size && @variant.pac_size > 1 %>
          <p class="text-sm text-gray-500">
            (<%= number_with_delimiter(@variant.pac_size) %> units per pack)
          </p>
        <% end %>
      </div>

      <%# SKU %>
      <p class="text-sm text-gray-500 mb-6">SKU: <%= @variant.sku %></p>

      <%# Add to Cart Form %>
      <%= form_with url: cart_cart_items_path, method: :post, class: "mb-8", data: { turbo_frame: "cart_drawer" } do |f| %>
        <%= f.hidden_field :product_variant_id, value: @variant.id %>

        <div class="flex items-center gap-4 mb-4">
          <label for="quantity" class="text-sm font-medium text-gray-700">Quantity:</label>
          <%= f.number_field :quantity, value: 1, min: 1, max: 99, class: "w-20 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" %>
          <span class="text-sm text-gray-500">packs</span>
        </div>

        <%= f.submit "Add to Cart", class: "w-full btn btn-primary" %>
      <% end %>

      <%# Product Description %>
      <% if @variant.description.present? %>
        <div class="prose prose-gray max-w-none">
          <h2 class="text-lg font-semibold mb-2">Description</h2>
          <p><%= @variant.description %></p>
        </div>
      <% end %>
    </div>
  </div>

  <%# Related Variants Section %>
  <% if @related_variants.any? %>
    <section class="mt-16">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">See Also</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <% @related_variants.each do |variant| %>
          <%= link_to product_variant_path(variant.slug), class: "group block" do %>
            <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden mb-3">
              <% if variant.primary_photo&.attached? %>
                <%= image_tag variant.primary_photo, class: "w-full h-full object-cover group-hover:scale-105 transition-transform", alt: variant.full_name %>
              <% end %>
            </div>
            <h3 class="font-medium text-gray-900 group-hover:text-emerald-600"><%= variant.name %></h3>
            <p class="text-gray-600"><%= number_to_currency(variant.price) %></p>
          <% end %>
        <% end %>
      </div>
    </section>
  <% end %>
</div>
