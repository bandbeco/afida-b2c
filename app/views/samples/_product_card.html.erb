<%# Individual product card for sample selection - entire card is clickable %>
<%
  in_cart ||= false
  at_limit ||= false
  error ||= nil

  # Accept pre-computed values from parent, or compute from database
  # Pre-computed values avoid N+1 queries on initial page load
  unless defined?(is_sample_in_cart) && defined?(is_regular_in_cart)
    cart_item = Current.cart&.cart_items&.samples&.find_by(product: product) if in_cart
    is_sample_in_cart = cart_item.present?
    is_regular_in_cart = in_cart && !is_sample_in_cart
  end

  # Find cart_item for remove button (only needed if sample is in cart)
  cart_item ||= Current.cart&.cart_items&.samples&.find_by(product: product) if is_sample_in_cart
%>

<%= turbo_frame_tag dom_id(product, :sample), class: "block" do %>
  <div class="card relative cursor-pointer <%= is_sample_in_cart ? 'bg-success/10 border-2 border-success' : 'bg-base-100 border-2 border-base-200' %> hover:shadow-lg transition-all [background-clip:padding-box] rounded-xl"
       data-controller="clickable-card"
       data-action="click->clickable-card#click keydown->clickable-card#keydown"
       role="article"
       aria-label="<%= product.generated_title %> sample">
    <!-- Selection Checkbox -->
    <div class="absolute top-2 right-2 z-10">
      <div class="w-6 h-6 rounded-full flex items-center justify-center <%= is_sample_in_cart ? 'bg-success text-success-content' : 'bg-base-200 border border-base-300' %>">
        <% if is_sample_in_cart %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
          </svg>
        <% end %>
      </div>
    </div>

    <% if error %>
      <!-- Warning Message - slides in from right, out to left -->
      <div class="absolute top-2 right-2 left-2 z-20 bg-warning/90 text-warning-content rounded-lg text-xs py-2 px-3 flex items-center gap-2 shadow-lg"
           data-controller="auto-dismiss"
           data-auto-dismiss-delay-value="3000"
           data-auto-dismiss-animation-value="slide-left">
        <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <span><%= error %></span>
      </div>
    <% end %>

    <!-- Product Image -->
    <figure class="px-4 pt-4">
      <% if product.primary_photo %>
        <%= image_tag product.primary_photo.variant(resize_and_pad: [200, 200, { background: [255, 255, 255] }]),
                      class: "rounded-lg w-full h-32 object-contain bg-white #{is_sample_in_cart ? 'opacity-90' : ''}",
                      alt: product.generated_title %>
      <% else %>
        <div class="w-full h-32 bg-base-200 rounded-lg flex items-center justify-center">
          <span class="text-4xl" role="img" aria-label="Product image placeholder">ðŸ“¦</span>
        </div>
      <% end %>
    </figure>

    <div class="card-body p-4">
      <!-- Product Name -->
      <h4 class="text-center line-clamp-2" title="<%= product.generated_title %>">
        <%= product.generated_title %>
      </h4>

      <!-- Action Button -->
      <div class="card-actions justify-center mt-2">
        <% if is_sample_in_cart %>
          <%# Sample in cart - show remove option %>
          <%= button_to cart_cart_item_path(cart_item),
                        method: :delete,
                        class: "btn btn-error btn-sm w-full gap-2",
                        data: { turbo_frame: dom_id(product, :sample), clickable_card_target: "button" } do %>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Remove
          <% end %>
        <% elsif is_regular_in_cart %>
          <%# Regular item in cart - show disabled state %>
          <button class="btn btn-disabled btn-sm w-full" disabled>
            In Cart
          </button>
        <% else %>
          <%# Add sample button - always enabled, server validates limit %>
          <%= button_to cart_cart_items_path,
                        class: "btn btn-primary btn-outline btn-sm w-full",
                        params: { product_id: product.id, sample: true },
                        data: { turbo_frame: dom_id(product, :sample), clickable_card_target: "button" } do %>
            Add Sample
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
