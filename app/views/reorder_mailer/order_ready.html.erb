<!DOCTYPE html>
<html>
<head>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .header { background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    .items-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    .items-table th, .items-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    .items-table th { background-color: #f8f9fa; font-weight: 600; }
    .totals { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; }
    .totals-row { display: flex; justify-content: space-between; padding: 5px 0; }
    .totals-row.total { font-weight: bold; font-size: 1.2em; border-top: 2px solid #333; padding-top: 10px; margin-top: 10px; }
    .btn { display: inline-block; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 600; margin: 5px; }
    .btn-primary { background-color: #10b981; color: white; }
    .btn-secondary { background-color: #6b7280; color: white; }
    .warning { background-color: #fef3c7; border: 1px solid #f59e0b; padding: 15px; border-radius: 8px; margin: 20px 0; }
    .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; color: #6b7280; font-size: 0.9em; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Your Reorder is Ready!</h1>
      <p>Hi <%= @user.email_address.split('@').first %>,</p>
      <p>Your scheduled order is ready for delivery on <strong><%= @pending_order.scheduled_for.strftime("%B %d, %Y") %></strong>.</p>
    </div>

    <% if @pending_order.unavailable_items.any? %>
      <div class="warning">
        <strong>Some items are no longer available:</strong>
        <ul>
          <% @pending_order.unavailable_items.each do |item| %>
            <li><%= item["product_name"] %> - <%= item["variant_name"] %> (<%= item["reason"] %>)</li>
          <% end %>
        </ul>
        <p>These items have been removed from your order. You can add different items by clicking "Edit Order" below.</p>
      </div>
    <% end %>

    <h2>Order Summary</h2>

    <table class="items-table">
      <thead>
        <tr>
          <th>Product</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        <% @pending_order.items.each do |item| %>
          <tr>
            <td>
              <strong><%= item["product_name"] %></strong><br>
              <span style="color: #6b7280; font-size: 0.9em;"><%= item["variant_name"] %></span>
            </td>
            <td><%= item["quantity"] %></td>
            <td>&pound;<%= item["price"] %></td>
            <td>&pound;<%= item["line_total"] %></td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <div class="totals">
      <div class="totals-row">
        <span>Subtotal</span>
        <span>&pound;<%= @pending_order.items_snapshot["subtotal"] %></span>
      </div>
      <div class="totals-row">
        <span>VAT (20%)</span>
        <span>&pound;<%= @pending_order.items_snapshot["vat"] %></span>
      </div>
      <div class="totals-row">
        <span>Shipping</span>
        <span>&pound;<%= @pending_order.items_snapshot["shipping"] %></span>
      </div>
      <div class="totals-row total">
        <span>Total</span>
        <span>&pound;<%= @pending_order.items_snapshot["total"] %></span>
      </div>
    </div>

    <div style="text-align: center; margin: 30px 0;">
      <a href="<%= @confirm_url %>" class="btn btn-primary">Confirm Order</a>
      <a href="<%= @edit_url %>" class="btn btn-secondary">Edit Order</a>
    </div>

    <p style="text-align: center; color: #6b7280;">
      Click "Confirm Order" to place your order using your saved payment method.
      <br>Or click "Edit Order" to make changes before confirming.
    </p>

    <div class="footer">
      <p>This order is part of your <%= @schedule.frequency.humanize.downcase %> reorder schedule.</p>
      <p>If you didn't request this, you can manage your schedules in your account settings.</p>
      <p>&copy; <%= Date.current.year %> Afida. All rights reserved.</p>
    </div>
  </div>
</body>
</html>
