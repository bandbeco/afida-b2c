<%# Collections mega-menu for navbar hover dropdown %>
<%# Displays collection names on left, preview image on right %>
<%# Includes backdrop overlay and slide-down animation %>
<%# Cached by collection updates; image variants pre-processed for performance %>

<% collections = Collection.regular.featured.by_position.includes(image_attachment: :blob) %>
<% default_collection = collections.first %>

<%# Pre-generate image variants to avoid on-demand processing %>
<% menu_variant = ->(collection) { collection.image.variant(resize_to_fill: [400, 400]).processed if collection&.image&.attached? } %>
<% default_image_url = default_collection ? url_for(menu_variant.call(default_collection)) : '' if default_collection&.image&.attached? %>

<div class="relative hidden lg:block"
     data-controller="mega-menu"
     data-mega-menu-default-image-value="<%= default_image_url || '' %>">

  <%# Trigger - hover to open mega-menu (not clickable) %>
  <span class="cursor-default hover:underline hover:decoration-secondary hover:decoration-2 hover:underline-offset-8 transition-colors flex items-center gap-1 <%= 'underline decoration-secondary decoration-2 underline-offset-8' if request.path.start_with?('/collections') %>"
        data-mega-menu-target="trigger"
        data-action="mouseenter->mega-menu#showPanel mouseleave->mega-menu#hidePanel">
    Collections
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </span>

  <%# Backdrop overlay - dims the rest of the page (starts below main navbar) %>
  <div class="hidden opacity-0 fixed inset-x-0 bottom-0 bg-black/30 z-40 transition-opacity duration-300"
       data-mega-menu-target="backdrop"
       data-action="click->mega-menu#hidePanel"
       style="top: 64px;">
  </div>

  <%# Dropdown panel with slide-down animation %>
  <div class="hidden opacity-0 -translate-y-3 absolute left-1/2 -translate-x-1/2 top-full pt-4 z-50 transition-all duration-300 ease-out"
       data-mega-menu-target="panel"
       data-action="mouseenter->mega-menu#cancelHide mouseleave->mega-menu#hidePanel">

    <% cache ["mega-menu-panel", collections.maximum(:updated_at), request.path.start_with?('/collections')] do %>
    <div class="mt-2 bg-base-100 rounded-xl shadow-2xl border border-base-200 p-8 min-w-[650px] flex flex-col">
      <div class="flex gap-8">
        <%# Left column - Collection links %>
        <nav class="flex flex-col gap-2 min-w-[220px]" aria-label="Collections">
          <% collections.each do |collection| %>
            <% variant = menu_variant.call(collection) %>
            <%= link_to collection_path(collection),
                        class: "text-2xl hover:text-primary transition-colors py-1",
                        data: {
                          mega_menu_target: "item",
                          action: "mouseenter->mega-menu#updatePreview mouseleave->mega-menu#resetPreview",
                          image_url: variant ? url_for(variant) : ''
                        } do %>
              <%= collection.name %>
            <% end %>
          <% end %>
        </nav>

        <%# Right column - Preview image %>
        <div class="w-[320px] h-[320px] rounded-lg overflow-hidden bg-base-200 flex-shrink-0">
        <% if default_collection&.image&.attached? %>
          <%= image_tag menu_variant.call(default_collection),
                        class: "w-full h-full object-cover",
                        data: { mega_menu_target: "preview" },
                        alt: "Collection preview" %>
        <% else %>
          <div class="w-full h-full flex items-center justify-center text-base-content/30"
               data-mega-menu-target="preview">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
        <% end %>
        </div>
      </div>

      <%# Footer - View all link %>
      <div class="mt-4 pt-4 border-t border-base-200 flex justify-end">
        <%= link_to collections_path, class: "text-sm text-base-content/60 hover:text-primary transition-colors" do %>
          View all collections â†’
        <% end %>
      </div>
    </div>
    <% end %>
  </div>
</div>
