<%= turbo_frame_tag cart_item do %>
  <%
    # Branded products use different path and don't need URL params
    # Standard products use variant option values to pre-select size/colour
    if cart_item.configured?
      product_url = branded_product_path(cart_item.product)
    else
      url_params = cart_item.product_variant.url_params
      product_url = product_path(cart_item.product, url_params)
    end
  %>
  <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-center p-4 border-b hover:bg-gray-50">
    <div class="col-span-full md:col-span-2 flex items-center space-x-4">
      <%= link_to product_path(cart_item.product, url_params), "aria-label": "View #{cart_item.product.name} details", data: { turbo: false }, class: "relative flex-shrink-0" do %>
        <%= product_photo_tag(cart_item.product_variant.primary_photo, alt: cart_item.product_variant.display_name, class: "w-20 h-20 rounded-md shadow") %>
        <% if cart_item.sample? %>
          <span class="absolute bottom-0 left-0 right-0 bg-primary text-primary-content text-xs text-center py-0.5 rounded-b-md">
            SAMPLE
          </span>
        <% end %>
      <% end %>
      <div>
        <%= link_to cart_item.product.name, product_url, class: "text-xl font-medium text-gray-800 hover:text-primary-500", data: { turbo: false } %>
        <% if cart_item.configured? %>
          <div class="text-gray-600">
            Size: <%= cart_item.configuration["size"] %>
          </div>
          <div class="text-gray-500 text-sm">
            Custom branded with your design
          </div>
        <% elsif cart_item.sample? %>
          <div class="text-lg">
            <%= cart_item.product_variant.name %>
          </div>
        <% else %>
          <div class="text-lg">
            <%= cart_item.product_variant.name %>
          </div>
          <% if cart_item.product_variant.pac_size.present? && cart_item.product_variant.pac_size > 1 %>
            <div class="text-gray-500 text-sm">
              Pack of <%= cart_item.product_variant.pac_size %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>

    <div class="text-left md:text-center text-gray-700">
      <span class="md:hidden font-semibold">Price: </span>
      <% if cart_item.sample? %>
        <span class="font-medium">Free</span>
      <% else %>
        <%= format_price_display(cart_item) %>
      <% end %>
    </div>

    <div class="text-left md:text-center">
      <% if cart_item.sample? %>
        <%# Samples are always quantity 1, no dropdown %>
        <span class="text-gray-600">1 unit</span>
      <% elsif cart_item.configured? %>
        <%
          # Branded products: offer standard quantity tiers
          current_qty = cart_item.quantity
          quantity_options = [1000, 2000, 3000, 5000, 7500, 10000, 15000, 20000, 30000]
          quantity_options << current_qty unless quantity_options.include?(current_qty)
          quantity_options.sort!
        %>
        <%= form_with(model: cart_item, url: cart_cart_item_path(cart_item), method: :patch, local: false) do |form| %>
          <%= form.label :quantity, "Quantity:", class: "sr-only" %>
          <%= form.select :quantity,
                          options_for_select(
                            quantity_options.map { |q| ["#{number_with_delimiter(q)} units", q] },
                            current_qty
                          ),
                          {},
                          class: "select select-sm select-bordered",
                          onchange: "this.form.requestSubmit(); this.blur()" %>
        <% end %>
      <% else %>
        <%
          # Standard products: quantity is number of packs
          variant = cart_item.product_variant
          pac_size = variant.pac_size || 1

          # Generate pack options (1-10 packs, plus larger quantities)
          pack_options = (1..10).to_a

          # Add larger pack quantities (30, 40, 50, 60 packs)
          [30, 40, 50, 60].each { |p| pack_options << p }

          # Always include current quantity if not in list
          pack_options << cart_item.quantity unless pack_options.include?(cart_item.quantity)
          pack_options.sort!.uniq!
        %>

        <%= form_with(model: cart_item, url: cart_cart_item_path(cart_item), method: :patch, local: false) do |form| %>
          <%= form.label :quantity, "Quantity:", class: "sr-only" %>
          <%# Value is number of packs, display shows "X packs (Y units)" %>
          <%= form.select :quantity,
                          options_for_select(
                            pack_options.map { |num_packs|
                              total_units = num_packs * pac_size
                              ["#{num_packs} #{num_packs == 1 ? 'pack' : 'packs'} (#{number_with_delimiter(total_units)} units)", num_packs]
                            },
                            cart_item.quantity
                          ),
                          {},
                          class: "select select-sm select-bordered",
                          onchange: "this.form.requestSubmit(); this.blur()" %>
        <% end %>
      <% end %>
    </div>

    <div class="text-right text-gray-700">
      <span class="md:hidden font-semibold">Total: </span>
      <span id="cart_item_<%= cart_item.id %>_total">
        <% if cart_item.sample? %>
          <span class="font-medium">Free</span>
        <% else %>
          <%= number_to_currency(cart_item.line_total) %>
        <% end %>
      </span>
    </div>

    <div class="text-right md:text-center">
      <%= button_to cart_cart_item_path(cart_item), method: :delete, class: "btn btn-ghost btn-sm group", local: false, title: "Remove item", data: { turbo_confirm: "Remove this item from your cart?" } do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/40 group-hover:text-error transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
      <% end %>
    </div>
  </div>
<% end %>