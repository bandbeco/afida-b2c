<% content_for :title, "Shopping Cart | Afida" %>

<%# GA4 E-commerce: view_cart event %>
<% content_for :head do %>
  <script>
    <%= ecommerce_view_cart_event(Current.cart) %>
  </script>
<% end %>

<div class="container mx-auto px-4 py-4 md:py-8 text-gray-800">
  <%= turbo_frame_tag "cart" do %>
    <% if Current.cart && Current.cart.cart_items.any? %>
      <h1 class="text-center">Your Shopping Cart</h1>

      <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <div class="hidden md:grid grid-cols-6 gap-4 items-center p-4 border-b font-medium text-gray-600">
          <div class="col-span-2">Product</div>
          <div class="text-center">Price</div>
          <div class="text-center">Quantity</div>
          <div class="text-right">Total</div>
        </div>

        <%= render cart_items %>
      </div>

      <div class="mt-4 md:mt-8 flex flex-col md:flex-row justify-between items-center md:items-start gap-4 md:gap-8">
        <div class="w-full md:w-1/2 lg:w-1/3">
          <% if show_discount_signup? %>
            <%= render "email_subscriptions/cart_signup_form" %>
          <% elsif session[:discount_code].present? %>
            <%= render "email_subscriptions/success", cart: Current.cart %>
          <% end %>
        </div>

        <div class="w-full md:w-1/2 lg:w-1/3 bg-gray-100 p-4 sm:p-6 rounded-lg shadow-md">
          <h2 class="text-lg sm:text-2xl mb-3 sm:mb-6">Cart Summary</h2>

          <div class="flex justify-between mb-2 text-sm sm:text-base text-gray-700">
            <span>Shipping</span>
            <span>Calculate at checkout</span>
          </div>

          <div class="flex justify-between mb-2 text-sm sm:text-base text-gray-700">
            <span>Subtotal</span>
            <span id="subtotal">
              <%= number_to_currency(Current.cart.subtotal_amount) %>
            </span>
          </div>

          <div class="flex justify-between mb-2 text-sm sm:text-base text-gray-700">
            <span>VAT <%= VAT_RATE * 100 %>%</span>
            <span id="vat">
              <%= number_to_currency(Current.cart.vat_amount) %>
            </span>
          </div>

          <div class="flex justify-between text-lg sm:text-xl text-gray-800 border-t pt-3 mt-3">
            <span>Total</span>
            <span id="grand_total">
              <%= number_to_currency(Current.cart.subtotal_amount + Current.cart.vat_amount) %>
            </span>
          </div>

          <%# Checkout form with optional address selection %>
          <%= form_with url: checkout_path, method: :post, data: {
                turbo: false,
                controller: "analytics",
                action: "submit->analytics#beginCheckout",
                analytics_cart_value_value: Current.cart.total_amount.to_f,
                analytics_cart_items_value: ga4_cart_items_json(Current.cart)
              } do |f| %>

            <% if Current.user&.has_saved_addresses? %>
              <%# Inline address selector for logged-in users %>
              <div class="mt-4 pt-4 border-t border-gray-200">
                <p class="text-sm font-medium text-gray-700 mb-3">Deliver to:</p>
                <div class="space-y-2">
                  <% Current.user.addresses.default_first.each do |address| %>
                    <label class="flex items-start gap-2 p-2 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors has-[:checked]:bg-primary/10 has-[:checked]:ring-1 has-[:checked]:ring-primary">
                      <input type="radio"
                             name="address_id"
                             value="<%= address.id %>"
                             class="radio radio-primary radio-sm mt-0.5"
                             <%= "checked" if address.default? %>>
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                          <span class="font-medium text-sm truncate"><%= address.nickname %></span>
                          <% if address.default? %>
                            <span class="badge badge-primary badge-xs">Default</span>
                          <% end %>
                        </div>
                        <p class="text-xs text-gray-500 truncate">
                          <%= address.line1 %>, <%= address.city %> <%= address.postcode %>
                        </p>
                      </div>
                    </label>
                  <% end %>

                  <%# Option to enter a different address %>
                  <label class="flex items-start gap-2 p-2 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors has-[:checked]:bg-primary/10 has-[:checked]:ring-1 has-[:checked]:ring-primary">
                    <input type="radio"
                           name="address_id"
                           value=""
                           class="radio radio-primary radio-sm mt-0.5">
                    <div class="flex-1">
                      <span class="font-medium text-sm">Enter a different address</span>
                      <p class="text-xs text-gray-500">I'll enter my address at checkout</p>
                    </div>
                  </label>
                </div>
              </div>
            <% end %>

            <div class="mt-4 sm:mt-6">
              <button type="submit"
                      class="btn btn-primary btn-block text-base sm:text-lg shadow-lg shadow-black/20">
                Proceed to Checkout
              </button>
            </div>
          <% end %>

          <div class="mt-4 flex justify-center">
            <%= render "shared/payment_methods" %>
          </div>

          <div class="divider my-2">or</div>

          <div class="text-center">
            <%= link_to "Continue Shopping", shop_path, class: "link text-primary-500 hover:text-primary-600 font-medium", data: { turbo: false } %>
          </div>
        </div>
      </div>

    <% else %>
      <div class="text-center py-20 bg-white rounded-lg shadow-md p-8">
        <svg aria-hidden="true" focusable="false" class="mx-auto h-24 w-24 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <h2 class="mt-4 text-2xl font-semibold text-gray-700">Your shopping cart is empty</h2>
        <div class="mt-6">
          <%= link_to "Start Shopping", shop_path, class: "btn btn-primary", data: { turbo: false } %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>