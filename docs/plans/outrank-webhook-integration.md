# Outrank Webhook Integration Plan

## Overview

Integrate Outrank.so's API Webhook to automatically receive and publish blog articles generated by their SEO content platform.

## Prerequisites

- ✅ Blog foundation implemented (branch `001-blog-foundation`)
- ✅ Blog models: `BlogPost`, `BlogCategory`
- ✅ Outrank account configured with Afida's business details, audiences, and competitors

## Existing BlogPost Model

```ruby
# Fields available:
# - title (string, required)
# - slug (string, required, unique, auto-generated from title)
# - body (text, required) - Markdown content
# - excerpt (text, optional)
# - published (boolean, default: false)
# - published_at (datetime)
# - meta_title (string, optional)
# - meta_description (text, optional)
# - blog_category_id (optional association)
# - cover_image (Active Storage attachment)
```

## Webhook Endpoint Design

### Route

```ruby
# config/routes.rb
namespace :api do
  namespace :webhooks do
    post 'outrank', to: 'outrank#create'
  end
end
```

**Endpoint URL**: `https://afida.com/api/webhooks/outrank`

### Controller

```ruby
# app/controllers/api/webhooks/outrank_controller.rb
module Api
  module Webhooks
    class OutrankController < ApplicationController
      skip_before_action :verify_authenticity_token
      before_action :verify_webhook_signature

      def create
        # Parse Outrank payload
        # Create BlogPost record
        # Download and attach images
        # Return success/failure response
      end

      private

      def verify_webhook_signature
        # Verify request is from Outrank using shared secret
        # Return 401 if invalid
      end
    end
  end
end
```

### Confirmed Payload Structure (from Outrank docs)

```json
{
  "event_type": "publish_articles",
  "timestamp": "2023-04-01T12:00:00Z",
  "data": {
    "articles": [
      {
        "id": "123456",
        "title": "How to Implement Webhooks",
        "content_markdown": "Webhooks are a powerful...",
        "content_html": "<p>Webhooks are a powerful...</p>",
        "meta_description": "Learn how to implement webhooks in your application",
        "created_at": "2023-03-31T10:30:00Z",
        "image_url": "https://example.com/images/webhook-article.jpg",
        "slug": "how-to-implement-webhooks",
        "tags": ["webhooks", "integration", "api"]
      }
    ]
  }
}
```

### Authentication

Outrank uses **Bearer token** in the Authorization header:
```
Authorization: Bearer your_access_token
```

### Field Mapping (Outrank → BlogPost)

| Outrank Field | BlogPost Field | Notes |
|---------------|----------------|-------|
| `id` | `outrank_id` (new) | For idempotency - need to add column |
| `title` | `title` | Direct mapping |
| `slug` | `slug` | Use Outrank's slug directly |
| `content_markdown` | `body` | Direct mapping (no conversion needed!) |
| `meta_description` | `meta_description` | Direct mapping |
| `image_url` | `cover_image` | Download and attach |
| `tags[0]` | `blog_category_id` | Find or create BlogCategory from first tag |
| - | `excerpt` | Extract from content_markdown (first paragraph) |
| `title` | `meta_title` | Use title as meta_title |
| - | `published` | Always `false` for admin review |

## Implementation Steps

### 1. Research Outrank Webhook API

- [x] Find Outrank webhook documentation ✅
- [x] Confirm exact payload structure ✅
- [x] Identify authentication method (Bearer token in Authorization header) ✅
- [x] Check if there's a test/sandbox mode (publish article manually to test) ✅

### 2. Add Migration for outrank_id

```ruby
# db/migrate/xxx_add_outrank_id_to_blog_posts.rb
add_column :blog_posts, :outrank_id, :string
add_index :blog_posts, :outrank_id, unique: true
```

### 3. Add Webhook Secret to Credentials

```bash
rails credentials:edit
```

```yaml
outrank:
  access_token: "your-access-token-from-outrank-dashboard"
```

### 4. Create Webhook Controller

- [ ] Create `Api::Webhooks::OutrankController`
- [ ] Implement Bearer token verification from Authorization header
- [ ] Parse incoming JSON payload (handle `data.articles[]` array)
- [ ] Map Outrank fields to BlogPost attributes
- [ ] Handle image downloads (Active Storage)
- [ ] Return appropriate HTTP status codes

### 5. Handle Content Processing

- [ ] Use `content_markdown` directly (no HTML conversion needed!)
- [ ] Download cover image from `image_url` and attach via Active Storage
- [ ] Find or create BlogCategory from first tag in `tags[]` array
- [ ] Extract first paragraph as `excerpt` from content_markdown
- [ ] Set `published: false` for admin review
- [ ] Store `outrank_id` for idempotency

### 6. Error Handling & Logging

- [ ] Log incoming webhooks for debugging
- [ ] Handle duplicate articles (idempotency)
- [ ] Notify admin of failures (optional)
- [ ] Return meaningful error responses to Outrank

### 7. Testing

- [ ] Unit tests for payload parsing
- [ ] Integration tests for webhook endpoint
- [ ] Test with Outrank's test webhook feature (if available)
- [ ] Verify images are attached correctly

### 8. Configure in Outrank Dashboard

- [ ] Enter webhook URL: `https://afida.com/api/webhooks/outrank`
- [ ] Configure authentication (add secret/API key)
- [ ] Test the connection
- [ ] Enable auto-publish if desired

## Security Considerations

1. **Verify webhook origin** - Validate Bearer token in Authorization header
2. **Rate limiting** - Prevent abuse (though Outrank is trusted)
3. **Input validation** - Sanitize Markdown content
4. **HTTPS only** - Webhook URL must be HTTPS in production

## Rollback Plan

If issues arise:
1. Disable auto-publish in Outrank dashboard
2. Webhook endpoint returns 503 to pause delivery
3. Articles queue in Outrank until resolved

## Dependencies

- ✅ `001-blog-foundation` branch merged
- ✅ BlogPost model with required fields
- ✅ Active Storage configured for images
- Production deployment with HTTPS

## Gems to Add

None required! Outrank provides `content_markdown` directly.

## Database Changes

```ruby
# Migration needed:
add_column :blog_posts, :outrank_id, :string
add_index :blog_posts, :outrank_id, unique: true
```

## Timeline

Ready to implement. Estimated: 2-3 hours (simplified since no HTML conversion needed).
